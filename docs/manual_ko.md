# Jiny E-Money & Point 시스템 매뉴얼

## 개요

Jiny E-Money & Point 시스템은 Laravel 기반의 전자화폐 및 포인트 관리 패키지입니다. 사용자들의 이머니 충전/출금, 포인트 적립/사용을 체계적으로 관리하며, 관리자가 이를 효율적으로 운영할 수 있는 기능을 제공합니다.

## 주요 기능

### 1. 이머니(E-Money) 시스템
- **전자지갑 관리**: 사용자별 이머니 계정 생성 및 관리
- **충전 기능**: 은행 계좌를 통한 이머니 충전
- **출금 기능**: 보유 이머니를 현금으로 출금
- **거래 내역**: 모든 충전/출금/사용 내역 추적
- **은행계좌 관리**: 사용자별 은행계좌 등록 및 관리

### 2. 포인트(Point) 시스템
- **포인트 적립**: 구매, 이벤트 참여 등을 통한 포인트 적립
- **포인트 사용**: 할인, 상품 교환 등에 포인트 사용
- **포인트 만료**: 유효기간 관리 및 자동 만료 처리
- **포인트 환불**: 주문 취소 시 포인트 환불 처리
- **만료 예정 알림**: 만료 예정 포인트 사전 알림

### 3. 관리자 기능
- **사용자 계정 관리**: 이머니/포인트 계정 조회 및 관리
- **거래 승인/거부**: 충전/출금 요청 검토 및 처리
- **시스템 설정**: 이머니/포인트 정책 설정
- **통계 및 리포트**: 사용 현황 및 통계 분석

## 시스템 구조

### 데이터베이스 테이블

#### 이머니 관련 테이블
- **user_emoney**: 사용자 이머니 계정 정보
- **user_emoney_deposit**: 충전 내역
- **user_emoney_withdraw**: 출금 내역
- **user_emoney_log**: 모든 거래 로그
- **user_emoney_bank**: 사용자 은행계좌 정보
- **auth_banks**: 시스템 지원 은행 목록

#### 포인트 관련 테이블
- **user_point**: 사용자 포인트 계정 정보
- **user_point_log**: 포인트 거래 로그
- **user_point_expiry**: 포인트 만료 스케줄

### 주요 모델

#### UserEmoney 모델
```php
// 사용자 이머니 지갑 조회/생성
$wallet = UserEmoney::findOrCreateForUser($userId);

// 잔액 추가 (충전)
$wallet->addBalance(10000, '계좌 이체 충전');

// 잔액 차감 (사용)
$wallet->subtractBalance(5000, '상품 구매');

// 포인트 적립
$wallet->addPoints(100, '구매 적립');
```

#### UserPoint 모델
```php
// 사용자 포인트 계정 조회/생성
$userPoint = UserPoint::findOrCreateForUser($userId);

// 포인트 적립 (30일 후 만료)
$userPoint->earnPoints(1000, '구매 적립', 'order', $orderId, now()->addDays(30));

// 포인트 사용
$userPoint->usePoints(500, '할인 사용', 'order', $orderId);

// 포인트 환불
$userPoint->refundPoints(200, '주문 취소', 'order', $orderId);
```

## 사용자 가이드

### 이머니 사용법

#### 1. 이머니 충전
1. **메뉴 접근**: `홈 > 이머니 > 충전`
2. **충전 금액 입력**: 원하는 충전 금액 입력
3. **은행계좌 선택**: 등록된 은행계좌 중 선택
4. **충전 신청**: 충전 신청 후 관리자 승인 대기
5. **충전 완료**: 승인 후 이머니 잔액에 반영

#### 2. 이머니 출금
1. **메뉴 접근**: `홈 > 이머니 > 출금`
2. **출금 금액 입력**: 출금할 금액 입력 (잔액 내에서)
3. **출금 계좌 선택**: 출금받을 은행계좌 선택
4. **출금 신청**: 출금 신청 후 관리자 승인 대기
5. **출금 완료**: 승인 후 해당 계좌로 입금

#### 3. 은행계좌 관리
1. **계좌 등록**: `홈 > 이머니 > 은행계좌 > 등록`
2. **계좌 정보 입력**: 은행명, 계좌번호, 예금주명 입력
3. **기본 계좌 설정**: 자주 사용하는 계좌를 기본으로 설정
4. **계좌 수정/삭제**: 등록된 계좌 정보 수정 또는 삭제

### 포인트 사용법

#### 1. 포인트 적립
- **구매 적립**: 상품 구매 시 자동 적립
- **이벤트 적립**: 특별 이벤트 참여를 통한 추가 적립
- **리뷰 적립**: 상품 리뷰 작성 시 적립
- **출석 적립**: 매일 출석체크를 통한 적립

#### 2. 포인트 사용
- **할인 사용**: 상품 구매 시 포인트로 할인
- **상품 교환**: 포인트로 직접 상품 교환
- **쿠폰 교환**: 포인트로 할인쿠폰 교환

#### 3. 포인트 만료 관리
- **만료일 확인**: `홈 > 포인트 > 만료 예정` 메뉴에서 확인
- **만료 알림**: 만료 7일 전 자동 알림 발송
- **선입선출**: 먼저 적립된 포인트부터 자동 사용

## 관리자 가이드

### 이머니 관리

#### 1. 충전 관리
1. **충전 요청 확인**: `관리자 > 이머니 > 충전 관리`
2. **요청 검토**: 충전 요청 내역 상세 확인
3. **승인/거부**: 요청에 대한 승인 또는 거부 처리
4. **입금 확인**: 실제 입금 여부 확인 후 승인

#### 2. 출금 관리
1. **출금 요청 확인**: `관리자 > 이머니 > 출금 관리`
2. **출금 가능 여부 확인**: 사용자 잔액 및 계좌 정보 확인
3. **출금 처리**: 승인 후 실제 계좌 이체 처리
4. **처리 완료**: 이체 완료 후 시스템에 완료 처리

#### 3. 사용자 이머니 관리
1. **계정 조회**: 특정 사용자의 이머니 계정 조회
2. **잔액 조정**: 필요 시 관리자 권한으로 잔액 조정
3. **거래 내역**: 사용자별 모든 거래 내역 확인
4. **계정 상태 관리**: 계정 활성화/비활성화 관리

### 포인트 관리

#### 1. 포인트 정책 설정
- **적립률 설정**: 구매 금액 대비 포인트 적립률 설정
- **만료 기간**: 포인트 유효 기간 설정
- **최소 사용 단위**: 포인트 사용 시 최소 단위 설정
- **최대 사용 한도**: 한 번에 사용 가능한 최대 포인트 설정

#### 2. 포인트 수동 조정
- **포인트 지급**: 이벤트, 보상 등을 위한 수동 지급
- **포인트 차감**: 부정 사용 등에 대한 포인트 차감
- **만료 처리**: 수동으로 특정 포인트 만료 처리

#### 3. 포인트 통계 및 분석
- **적립/사용 현황**: 전체 포인트 적립 및 사용 현황
- **만료율 분석**: 포인트 만료율 및 활용도 분석
- **사용자 활동**: 사용자별 포인트 활동 패턴 분석

### 시스템 설정

#### 1. 기본 설정
```json
{
  "currency": "KRW",
  "min_deposit": 1000,
  "max_deposit": 1000000,
  "min_withdraw": 1000,
  "max_withdraw": 500000,
  "point_rate": 0.01,
  "point_expiry_days": 365
}
```

#### 2. 은행 관리
- **지원 은행 관리**: 충전/출금 가능한 은행 목록 관리
- **수수료 설정**: 충전/출금 시 수수료 정책 설정
- **처리 시간**: 충전/출금 처리 소요 시간 설정

## API 문서

### 이머니 API

#### 잔액 조회
```http
GET /api/emoney/balance
Authorization: Bearer {token}
```

#### 충전 신청
```http
POST /api/emoney/deposit
Content-Type: application/json
Authorization: Bearer {token}

{
  "amount": 10000,
  "bank_id": 1,
  "memo": "충전 신청"
}
```

#### 출금 신청
```http
POST /api/emoney/withdraw
Content-Type: application/json
Authorization: Bearer {token}

{
  "amount": 5000,
  "bank_id": 1,
  "memo": "출금 신청"
}
```

### 포인트 API

#### 포인트 잔액 조회
```http
GET /api/point/balance
Authorization: Bearer {token}
```

#### 포인트 사용
```http
POST /api/point/use
Content-Type: application/json
Authorization: Bearer {token}

{
  "amount": 1000,
  "reference_type": "order",
  "reference_id": 123,
  "reason": "할인 사용"
}
```

## 보안 고려사항

### 1. 거래 보안
- **이중 검증**: 모든 금융 거래는 이중 검증 과정을 거침
- **거래 로그**: 모든 거래는 변경 불가능한 로그로 기록
- **잔액 검증**: 정기적인 잔액 정합성 검사 실시

### 2. 사용자 인증
- **JWT 토큰**: API 접근 시 JWT 토큰 기반 인증
- **세션 관리**: 웹 접근 시 세션 기반 인증
- **권한 관리**: 사용자별 접근 권한 세분화

### 3. 데이터 보호
- **암호화**: 민감한 정보는 암호화하여 저장
- **접근 제어**: 데이터베이스 접근 권한 엄격 관리
- **감사 로그**: 모든 관리자 작업은 감사 로그로 기록

## 트러블슈팅

### 자주 발생하는 문제

#### 1. 충전이 승인되지 않는 경우
- **원인**: 입금 확인 불가, 계좌 정보 불일치
- **해결**: 관리자에게 입금 확인 요청, 계좌 정보 재확인

#### 2. 포인트가 적립되지 않는 경우
- **원인**: 시스템 오류, 적립 정책 미충족
- **해결**: 거래 내역 확인, 관리자에게 수동 적립 요청

#### 3. 출금이 지연되는 경우
- **원인**: 관리자 승인 대기, 은행 업무 시간 외
- **해결**: 영업일 기준 처리, 긴급 시 관리자 연락

### 시스템 오류 대응

#### 1. 잔액 불일치
```php
// 잔액 정합성 검사 명령어
php artisan emoney:balance-check

// 잔액 재계산
php artisan emoney:balance-recalculate
```

#### 2. 포인트 만료 처리
```php
// 만료 포인트 일괄 처리
php artisan point:expire-batch

// 만료 예정 알림 발송
php artisan point:expiry-notification
```

## 업데이트 및 마이그레이션

### 패키지 업데이트
```bash
# Composer를 통한 패키지 업데이트
composer update jiny/emoney

# 마이그레이션 실행
php artisan migrate

# 설정 파일 업데이트
php artisan vendor:publish --provider="Jiny\Emoney\EmoneyServiceProvider"
```

### 데이터 마이그레이션
- **기존 시스템 연동**: 기존 포인트/이머니 데이터 마이그레이션 지원
- **백업**: 마이그레이션 전 반드시 데이터 백업 실시
- **테스트**: 개발 환경에서 마이그레이션 테스트 후 운영 적용

## 성능 최적화

### 1. 데이터베이스 최적화
- **인덱스**: 주요 컬럼에 적절한 인덱스 설정
- **파티셔닝**: 대용량 로그 테이블 파티셔닝 적용
- **캐싱**: 자주 조회되는 데이터 Redis 캐싱

### 2. 배치 처리
- **만료 처리**: 포인트 만료를 배치 작업으로 처리
- **통계 계산**: 일일 통계를 배치로 미리 계산
- **알림 발송**: 대량 알림을 큐 시스템으로 처리

## 법적 준수사항

### 1. 전자금융거래법
- **거래 기록**: 모든 전자금융거래 기록 보관
- **보안 요구사항**: 법정 보안 요구사항 준수
- **분쟁 처리**: 전자금융거래 분쟁 처리 절차 수립

### 2. 개인정보보호
- **정보 수집**: 최소한의 개인정보만 수집
- **정보 보호**: 개인정보 암호화 및 접근 제어
- **정보 파기**: 보유 기간 만료 시 정보 안전 파기

## 연락처 및 지원

### 기술 지원
- **이메일**: support@jiny.dev
- **문서**: https://docs.jiny.dev/emoney
- **GitHub**: https://github.com/jinyphp/emoney

### 긴급 상황
- **24시간 지원**: 운영 중 긴급 상황 시 24시간 지원
- **백업 시스템**: 자동 백업 시스템으로 데이터 안전성 보장
- **복구 절차**: 시스템 장애 시 신속한 복구 절차 수립

---

본 매뉴얼은 Jiny E-Money & Point 시스템의 전반적인 사용법과 관리 방법을 다룹니다. 추가적인 문의사항이나 기술적 지원이 필요한 경우 위의 연락처로 문의해 주시기 바랍니다.